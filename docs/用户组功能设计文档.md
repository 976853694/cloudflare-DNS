# 用户组功能设计文档

## 📋 功能概述

为六趣DNS管理系统添加用户组权限管理功能，实现分层权限控制和差异化积分消耗策略。

---

## 🎯 核心需求

### 1. 用户组类型
- **默认组 (default)**: 普通用户组，基础权限
- **VIP组 (vip)**: 高级用户组，更多权限和优惠
- **SVIP组 (svip)**: 超级VIP，最高权限和最大优惠

### 2. 功能特性
- ✅ 新用户注册自动分配到"默认组"
- ✅ 已注册用户默认归属"默认组"
- ✅ 管理员可修改用户所属组
- ✅ 每个用户组可设置：
  - 可访问的域名列表（白名单）
  - 每条DNS记录消耗的积分数
  - 用户组描述和特权说明
- ✅ 用户添加记录时自动应用组权限和积分策略

---

## 🗄️ 数据库设计

### ⚠️ 重要说明

**数据库表的创建和初始化位置：**
1. **新安装系统**: 在 `config/database.php` 的 `initUserGroupTables()` 方法中自动创建
2. **已安装系统**: 在首次访问 `admin/user_groups.php` 时自动检测并创建表
3. **表结构升级**: 同样在 `admin/user_groups.php` 中检测字段是否完整，自动添加缺失字段

**实现逻辑：**
```php
// config/database.php - initTables() 方法中调用
$this->initUserGroupTables(); // 创建用户组相关表

// admin/user_groups.php - 页面加载时自动执行
initializeUserGroupTables($db); // 检测并创建/升级表
```

---

### 1. 用户组表 (user_groups)

```sql
CREATE TABLE user_groups (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    group_name TEXT NOT NULL UNIQUE,           -- 组名 (default, vip, svip)
    display_name TEXT NOT NULL,                 -- 显示名称
    points_per_record INTEGER DEFAULT 1,        -- 每条记录消耗积分
    description TEXT DEFAULT '',                 -- 用户组描述
    is_active INTEGER DEFAULT 1,                -- 是否启用
    can_access_all_domains INTEGER DEFAULT 0,   -- 是否可访问所有域名
    max_records INTEGER DEFAULT -1,             -- 最大记录数限制 (-1表示无限制)
    priority INTEGER DEFAULT 0,                  -- 优先级（数字越大优先级越高）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**默认数据：**
```sql
INSERT INTO user_groups (group_name, display_name, points_per_record, description, priority, can_access_all_domains, max_records) VALUES
('default', '默认组', 1, '普通用户，基础权限', 0, 0, 100),
('vip', 'VIP组', 1, 'VIP用户，享受更多域名权限和优惠', 10, 0, 500),
('svip', 'SVIP组', 0, '超级VIP用户，免积分解析，全域名权限', 20, 1, -1);
```

### 2. 用户组域名权限表 (user_group_domains)

```sql
CREATE TABLE user_group_domains (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    group_id INTEGER NOT NULL,                  -- 用户组ID
    domain_id INTEGER NOT NULL,                 -- 域名ID
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (group_id) REFERENCES user_groups(id) ON DELETE CASCADE,
    FOREIGN KEY (domain_id) REFERENCES domains(id) ON DELETE CASCADE,
    UNIQUE(group_id, domain_id)                 -- 防止重复关联
);
```

### 3. 修改用户表 (users)

```sql
-- 添加用户组字段
ALTER TABLE users ADD COLUMN group_id INTEGER DEFAULT 1;
ALTER TABLE users ADD COLUMN group_changed_at TIMESTAMP DEFAULT NULL;
ALTER TABLE users ADD COLUMN group_changed_by INTEGER DEFAULT NULL;

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_users_group_id ON users(group_id);
```

---

## 📐 业务逻辑设计

### 1. 用户注册流程

```
用户注册 → 创建用户账户 → 自动分配 group_id = 1 (默认组) 
→ 初始化积分 → 发送欢迎邮件
```

### 2. 用户添加DNS记录流程

```mermaid
用户添加记录请求
    ↓
查询用户所属组
    ↓
检查组是否启用 ← 否 → 拒绝操作
    ↓ 是
检查域名访问权限
    ├─ 可访问全部域名？ → 是 → 通过
    └─ 否 → 检查域名白名单 ← 不在白名单 → 拒绝操作
        ↓ 在白名单
检查记录数量限制
    ├─ 无限制(-1)？ → 是 → 通过
    └─ 否 → 当前记录数 < 最大限制？
        ├─ 是 → 通过
        └─ 否 → 拒绝操作
            ↓
获取组的积分消耗策略 (points_per_record)
    ↓
检查用户积分是否充足
    ├─ 积分 >= 所需积分？ → 是 → 继续
    └─ 否 → 拒绝操作（积分不足）
        ↓
调用DNS API创建记录
    ↓
扣除相应积分
    ↓
保存到本地数据库
    ↓
记录操作日志
    ↓
返回成功
```

### 3. 权限检查函数设计

```php
/**
 * 检查用户是否有权限访问指定域名
 * @param int $user_id 用户ID
 * @param int $domain_id 域名ID
 * @return bool
 */
function checkUserDomainPermission($user_id, $domain_id);

/**
 * 获取用户可访问的域名列表
 * @param int $user_id 用户ID
 * @return array 域名数组
 */
function getUserAccessibleDomains($user_id);

/**
 * 获取用户组信息
 * @param int $user_id 用户ID
 * @return array|null 用户组信息
 */
function getUserGroup($user_id);

/**
 * 计算用户添加记录所需积分
 * @param int $user_id 用户ID
 * @return int 所需积分数
 */
function getRequiredPoints($user_id);

/**
 * 检查用户是否达到记录数量限制
 * @param int $user_id 用户ID
 * @return bool
 */
function checkUserRecordLimit($user_id);
```

---

## 🎨 前端页面设计

### 1. 管理后台 - 用户组管理页面 (admin/user_groups.php)

**⚠️ 重要：页面自动检测和初始化表结构**

```php
<?php
session_start();
require_once __DIR__ . '/../config/database.php';
require_once __DIR__ . '/../includes/functions.php';

checkAdminLogin();

$db = Database::getInstance()->getConnection();

// 🔥 自动检测并初始化用户组表
initializeUserGroupTables($db);

/**
 * 初始化用户组表结构
 * 检测表是否存在，不存在则创建
 * 检测字段是否完整，缺失则添加
 */
function initializeUserGroupTables($db) {
    try {
        // 1. 检查 user_groups 表是否存在
        $table_exists = $db->querySingle("
            SELECT COUNT(*) FROM sqlite_master 
            WHERE type='table' AND name='user_groups'
        ");
        
        if (!$table_exists) {
            // 创建用户组表
            $db->exec("CREATE TABLE user_groups (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                group_name TEXT NOT NULL UNIQUE,
                display_name TEXT NOT NULL,
                points_per_record INTEGER DEFAULT 1,
                description TEXT DEFAULT '',
                is_active INTEGER DEFAULT 1,
                can_access_all_domains INTEGER DEFAULT 0,
                max_records INTEGER DEFAULT -1,
                priority INTEGER DEFAULT 0,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )");
            
            // 插入默认数据
            $default_groups = [
                ['default', '默认组', 1, '普通用户，基础权限', 0, 0, 100],
                ['vip', 'VIP组', 1, 'VIP用户，享受更多域名权限', 10, 0, 500],
                ['svip', 'SVIP组', 0, '超级VIP用户，免积分解析，全域名权限', 20, 1, -1]
            ];
            
            foreach ($default_groups as $group) {
                $stmt = $db->prepare("
                    INSERT INTO user_groups 
                    (group_name, display_name, points_per_record, description, priority, can_access_all_domains, max_records) 
                    VALUES (?, ?, ?, ?, ?, ?, ?)
                ");
                $stmt->bindValue(1, $group[0], SQLITE3_TEXT);
                $stmt->bindValue(2, $group[1], SQLITE3_TEXT);
                $stmt->bindValue(3, $group[2], SQLITE3_INTEGER);
                $stmt->bindValue(4, $group[3], SQLITE3_TEXT);
                $stmt->bindValue(5, $group[4], SQLITE3_INTEGER);
                $stmt->bindValue(6, $group[5], SQLITE3_INTEGER);
                $stmt->bindValue(7, $group[6], SQLITE3_INTEGER);
                $stmt->execute();
            }
        }
        
        // 2. 检查 user_group_domains 表是否存在
        $table_exists = $db->querySingle("
            SELECT COUNT(*) FROM sqlite_master 
            WHERE type='table' AND name='user_group_domains'
        ");
        
        if (!$table_exists) {
            $db->exec("CREATE TABLE user_group_domains (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                group_id INTEGER NOT NULL,
                domain_id INTEGER NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (group_id) REFERENCES user_groups(id) ON DELETE CASCADE,
                FOREIGN KEY (domain_id) REFERENCES domains(id) ON DELETE CASCADE,
                UNIQUE(group_id, domain_id)
            )");
        }
        
        // 3. 检查 users 表是否有 group_id 字段
        $columns = $db->query("PRAGMA table_info(users)");
        $has_group_id = false;
        
        if ($columns) {
            while ($column = $columns->fetchArray(SQLITE3_ASSOC)) {
                if ($column['name'] === 'group_id') {
                    $has_group_id = true;
                    break;
                }
            }
        }
        
        if (!$has_group_id) {
            $db->exec("ALTER TABLE users ADD COLUMN group_id INTEGER DEFAULT 1");
            $db->exec("ALTER TABLE users ADD COLUMN group_changed_at TIMESTAMP DEFAULT NULL");
            $db->exec("ALTER TABLE users ADD COLUMN group_changed_by INTEGER DEFAULT NULL");
            $db->exec("CREATE INDEX IF NOT EXISTS idx_users_group_id ON users(group_id)");
        }
        
        // 4. 创建索引
        $db->exec("CREATE INDEX IF NOT EXISTS idx_user_group_domains_group ON user_group_domains(group_id)");
        $db->exec("CREATE INDEX IF NOT EXISTS idx_user_group_domains_domain ON user_group_domains(domain_id)");
        
        return true;
        
    } catch (Exception $e) {
        error_log("初始化用户组表失败: " . $e->getMessage());
        return false;
    }
}

// ... 页面其余代码
?>
```

---

**页面布局：**
```
┌─────────────────────────────────────────┐
│ 用户组管理                                │
├─────────────────────────────────────────┤
│ [➕ 添加用户组] [🔄 刷新]                 │
├─────────────────────────────────────────┤
│ 用户组列表表格：                           │
│ ┌────┬────────┬─────┬──────┬────┬────┐ │
│ │ID  │ 组名    │显示名│积分/条│优先级│操作│ │
│ ├────┼────────┼─────┼──────┼────┼────┤ │
│ │ 1  │default │默认组│  1   │  0 │编辑│ │
│ │ 2  │vip     │VIP组 │  1   │ 10 │编辑│ │
│ │ 3  │svip    │SVIP组│  0   │ 20 │编辑│ │
│ └────┴────────┴─────┴──────┴────┴────┘ │
└─────────────────────────────────────────┘
```

**功能按钮：**
- 编辑：修改用户组信息、设置域名权限
- 删除：删除自定义用户组（默认组不可删除）
- 域名权限：配置该组可访问的域名

### 2. 用户组编辑Modal

```html
┌────────────────────────────────────┐
│ 编辑用户组                          │
├────────────────────────────────────┤
│ 组名: [default]  (不可修改)        │
│ 显示名称: [默认组]                  │
│ 每条记录积分: [1] 分                │
│ 最大记录数: [100] (-1表示无限制)   │
│ 优先级: [0]                         │
│ 描述: [普通用户，基础权限]          │
│                                     │
│ 域名访问权限:                       │
│ ☐ 允许访问所有域名                  │
│ 或选择可访问的域名:                 │
│ ☑ example.com                      │
│ ☑ test.com                         │
│ ☐ demo.com                         │
│                                     │
│ [取消] [保存]                       │
└────────────────────────────────────┘
```

### 3. 用户管理页面 - 添加用户组列

**修改 admin/users.php 表格：**
```
┌────┬────────┬──────┬────────┬──────┬────┬────┐
│ ID │ 用户名  │ 邮箱  │ 用户组  │ 积分  │状态│操作│
├────┼────────┼──────┼────────┼──────┼────┼────┤
│ 1  │ user1  │***   │ 默认组  │ 100  │正常│... │
│ 2  │ user2  │***   │ VIP组   │ 500  │正常│... │
│ 3  │ user3  │***   │ SVIP组  │ 1000 │正常│... │
└────┴────────┴──────┴────────┴──────┴────┴────┘
```

**操作菜单增加：**
- 修改用户组：选择新的用户组
- 查看组权限：查看该用户组的详细权限

### 4. 用户前台 - 显示用户组信息

**在 user/dashboard.php 顶部显示：**
```html
┌──────────────────────────────────────┐
│ 👤 欢迎, user1                        │
│ 💎 用户组: VIP组                      │
│ 💰 当前积分: 500                      │
│ 📊 已用记录: 25/500                   │
│ 💳 每条记录消耗: 1 积分               │
└──────────────────────────────────────┘
```

---

## 🔧 核心代码实现

### 0. 数据库表初始化 (config/database.php)

**在 `Database` 类中添加方法：**

```php
/**
 * 初始化用户组相关表
 * 在 initTables() 方法中调用
 */
private function initUserGroupTables() {
    // 1. 创建用户组表
    $this->db->exec("CREATE TABLE IF NOT EXISTS user_groups (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        group_name TEXT NOT NULL UNIQUE,
        display_name TEXT NOT NULL,
        points_per_record INTEGER DEFAULT 1,
        description TEXT DEFAULT '',
        is_active INTEGER DEFAULT 1,
        can_access_all_domains INTEGER DEFAULT 0,
        max_records INTEGER DEFAULT -1,
        priority INTEGER DEFAULT 0,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )");
    
    // 2. 创建用户组域名权限表
    $this->db->exec("CREATE TABLE IF NOT EXISTS user_group_domains (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        group_id INTEGER NOT NULL,
        domain_id INTEGER NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (group_id) REFERENCES user_groups(id) ON DELETE CASCADE,
        FOREIGN KEY (domain_id) REFERENCES domains(id) ON DELETE CASCADE,
        UNIQUE(group_id, domain_id)
    )");
    
    // 3. 检查并添加 users 表的 group_id 字段
    try {
        $columns = $this->db->query("PRAGMA table_info(users)");
        $has_group_id = false;
        
        if ($columns) {
            while ($column = $columns->fetchArray(SQLITE3_ASSOC)) {
                if ($column['name'] === 'group_id') {
                    $has_group_id = true;
                    break;
                }
            }
        }
        
        if (!$has_group_id) {
            $this->db->exec("ALTER TABLE users ADD COLUMN group_id INTEGER DEFAULT 1");
            $this->db->exec("ALTER TABLE users ADD COLUMN group_changed_at TIMESTAMP DEFAULT NULL");
            $this->db->exec("ALTER TABLE users ADD COLUMN group_changed_by INTEGER DEFAULT NULL");
        }
    } catch (Exception $e) {
        // 忽略错误，字段可能已存在
    }
    
    // 4. 插入默认用户组数据
    $this->insertDefaultUserGroups();
    
    // 5. 创建索引
    try {
        $this->db->exec("CREATE INDEX IF NOT EXISTS idx_users_group_id ON users(group_id)");
        $this->db->exec("CREATE INDEX IF NOT EXISTS idx_user_group_domains_group ON user_group_domains(group_id)");
        $this->db->exec("CREATE INDEX IF NOT EXISTS idx_user_group_domains_domain ON user_group_domains(domain_id)");
    } catch (Exception $e) {
        // 忽略索引创建错误
    }
}

/**
 * 插入默认用户组数据
 */
private function insertDefaultUserGroups() {
    $default_groups = [
        ['default', '默认组', 1, '普通用户，基础权限', 0, 0, 100],
        ['vip', 'VIP组', 1, 'VIP用户，享受更多域名权限', 10, 0, 500],
        ['svip', 'SVIP组', 0, '超级VIP用户，免积分解析，全域名权限', 20, 1, -1]
    ];
    
    foreach ($default_groups as $group) {
        try {
            // 检查是否已存在
            $exists = $this->db->querySingle("SELECT COUNT(*) FROM user_groups WHERE group_name = '{$group[0]}'");
            if (!$exists) {
                $stmt = $this->db->prepare("
                    INSERT INTO user_groups 
                    (group_name, display_name, points_per_record, description, priority, can_access_all_domains, max_records) 
                    VALUES (?, ?, ?, ?, ?, ?, ?)
                ");
                $stmt->bindValue(1, $group[0], SQLITE3_TEXT);
                $stmt->bindValue(2, $group[1], SQLITE3_TEXT);
                $stmt->bindValue(3, $group[2], SQLITE3_INTEGER);
                $stmt->bindValue(4, $group[3], SQLITE3_TEXT);
                $stmt->bindValue(5, $group[4], SQLITE3_INTEGER);
                $stmt->bindValue(6, $group[5], SQLITE3_INTEGER);
                $stmt->bindValue(7, $group[6], SQLITE3_INTEGER);
                $stmt->execute();
            }
        } catch (Exception $e) {
            // 忽略插入错误
            error_log("插入默认用户组失败: " . $e->getMessage());
        }
    }
}
```

**在 `initTables()` 方法末尾调用：**
```php
// 初始化用户组表（如果不存在则创建）
$this->initUserGroupTables();
```

---

### 1. 用户组权限检查类 (includes/user_groups.php)

```php
class UserGroupManager {
    private $db;
    
    /**
     * 获取用户组信息
     */
    public function getUserGroup($user_id);
    
    /**
     * 检查用户是否有权限访问域名
     */
    public function checkDomainPermission($user_id, $domain_id);
    
    /**
     * 获取用户可访问的域名列表
     */
    public function getAccessibleDomains($user_id);
    
    /**
     * 获取用户所需积分
     */
    public function getRequiredPoints($user_id);
    
    /**
     * 检查记录数量限制
     */
    public function checkRecordLimit($user_id);
    
    /**
     * 修改用户组
     */
    public function changeUserGroup($user_id, $new_group_id, $admin_id);
}
```

### 2. 修改用户注册逻辑 (user/login.php)

```php
// 注册时自动分配默认组
$default_group_id = 1; // 默认组ID

$stmt = $db->prepare("
    INSERT INTO users (username, password, email, points, group_id, created_at) 
    VALUES (?, ?, ?, ?, ?, datetime('now'))
");
$stmt->bindValue(4, $default_group_id, SQLITE3_INTEGER);
```

### 3. 修改DNS记录添加逻辑 (user/dashboard.php)

```php
// 1. 获取用户组信息
$group = getUserGroup($user_id);

// 2. 检查域名权限
if (!checkUserDomainPermission($user_id, $domain_id)) {
    showError('您的用户组无权访问此域名！');
    redirect('dashboard.php');
}

// 3. 检查记录数量限制
if (!checkUserRecordLimit($user_id)) {
    showError('您已达到该用户组的最大记录数限制！');
    redirect('dashboard.php');
}

// 4. 获取所需积分
$required_points = getRequiredPoints($user_id);

// 5. 检查积分是否充足
if ($user_points < $required_points) {
    showError("积分不足！需要 {$required_points} 积分，您当前有 {$user_points} 积分。");
    redirect('dashboard.php');
}

// 6. 创建记录并扣除积分
// ... 原有逻辑 ...
$new_points = $user_points - $required_points;
```

---

## 📊 管理后台页面列表

### 新增页面：
1. **admin/user_groups.php** - 用户组管理主页
2. **admin/user_group_domains.php** - 用户组域名权限配置（或集成到user_groups.php）

### 修改页面：
1. **admin/users.php** - 添加用户组列和修改组功能
2. **user/dashboard.php** - 显示用户组信息和权限提示
3. **user/profile.php** - 显示用户组信息

---

## 🎯 实现步骤

### Phase 1: 数据库层（优先级最高）

#### 步骤1：修改 `config/database.php`
```php
// 在 Database 类中添加：
1. private function initUserGroupTables() 方法
2. private function insertDefaultUserGroups() 方法
3. 在 initTables() 末尾调用 $this->initUserGroupTables()
```

#### 步骤2：创建 `admin/user_groups.php` 
```php
1. 页面顶部添加 initializeUserGroupTables($db) 函数
2. 检测表是否存在，不存在则创建
3. 检测字段是否完整，缺失则补充
4. 创建必要的索引
```

#### 数据库表清单
- ✅ 创建 `user_groups` 表 (在 config/database.php 和 admin/user_groups.php 中)
- ✅ 创建 `user_group_domains` 表 (在 config/database.php 和 admin/user_groups.php 中)
- ✅ 修改 `users` 表，添加 `group_id` 字段 (在两处都检测)
- ✅ 插入默认用户组数据 (default, vip, svip)
- ✅ 创建索引 (提升查询性能)

### Phase 2: 业务逻辑层
1. ✅ 创建 `UserGroupManager` 类
2. ✅ 实现权限检查函数
3. ✅ 实现积分计算函数
4. ✅ 修改用户注册逻辑
5. ✅ 修改DNS记录添加逻辑

### Phase 3: 管理后台
1. ✅ 创建用户组管理页面
2. ✅ 实现用户组CRUD操作
3. ✅ 实现域名权限配置界面
4. ✅ 修改用户管理页面，添加组管理
5. ✅ 添加侧边栏导航入口

### Phase 4: 用户前台
1. ✅ 在控制台显示用户组信息
2. ✅ 域名列表只显示有权限的域名
3. ✅ 添加记录时显示积分消耗提示
4. ✅ 优化用户体验和提示信息

### Phase 5: 测试和优化
1. ✅ 测试权限检查逻辑
2. ✅ 测试积分计算逻辑
3. ✅ 测试用户组切换
4. ✅ 性能优化
5. ✅ 文档更新

---

## 🚀 扩展功能（可选）

### 1. 用户组升级申请
- 用户可申请升级到VIP/SVIP
- 管理员审核通过后自动升级

### 2. 用户组到期机制
- 添加 `group_expire_at` 字段
- VIP/SVIP可设置有效期
- 到期自动降级为默认组

### 3. 积分折扣系统
- VIP: 9折积分消耗
- SVIP: 免费或5折

### 4. 用户组统计
- 各用户组人数统计
- 各用户组记录数统计
- 各用户组活跃度分析

---

## 📝 示例配置

### 默认用户组配置表

| 用户组 | 显示名 | 积分/条 | 最大记录 | 全域名访问 | 优先级 |
|--------|--------|---------|----------|------------|--------|
| default| 默认组 | 1       | 100      | ❌         | 0      |
| vip    | VIP组  | 1       | 500      | ❌         | 10     |
| svip   | SVIP组 | 0       | -1(无限) | ✅         | 20     |

### 域名权限配置示例

**默认组可访问域名：**
- example.com
- test.com

**VIP组可访问域名：**
- example.com
- test.com
- premium.com
- vip.com

**SVIP组：**
- 可访问所有域名 (can_access_all_domains = 1)

---

## 🔒 安全考虑

1. **权限验证**：每次操作前必须验证用户组权限
2. **SQL注入防护**：使用预处理语句
3. **操作日志**：记录所有用户组变更操作
4. **数据一致性**：使用外键约束和事务
5. **缓存策略**：用户组信息可缓存到Session

---

## 📚 相关文件清单

### 新增文件：
1. **`includes/user_groups.php`** - 用户组管理类（核心业务逻辑）
2. **`admin/user_groups.php`** - 用户组管理页面（含自动检测和初始化）

### 修改文件（按优先级排序）：

#### 🔴 优先级1：数据库和核心逻辑
1. **`config/database.php`** 
   - 添加 `initUserGroupTables()` 方法
   - 添加 `insertDefaultUserGroups()` 方法
   - 在 `initTables()` 中调用

2. **`includes/functions.php`** 
   - 添加 `getUserGroup()` 函数
   - 添加 `checkUserDomainPermission()` 函数
   - 添加 `getUserAccessibleDomains()` 函数
   - 添加 `getRequiredPoints()` 函数
   - 添加 `checkUserRecordLimit()` 函数

#### 🟡 优先级2：用户注册和记录逻辑
3. **`user/login.php`** 
   - 注册时设置 `group_id = 1` (默认组)

4. **`user/dashboard.php`** 
   - 添加用户组信息显示
   - 添加域名权限检查
   - 添加记录数量限制检查
   - 修改积分计算逻辑

#### 🟢 优先级3：管理后台功能
5. **`admin/users.php`** 
   - 添加用户组列显示
   - 添加修改用户组功能
   - 添加批量修改用户组

6. **`admin/includes/sidebar.php`** 
   - 添加"用户组管理"菜单项

#### 🔵 优先级4：前台显示优化
7. **`user/profile.php`** 
   - 显示用户组信息
   - 显示组权限说明

---

## ✅ 测试用例

### 1. 权限测试
- ✅ 默认组用户只能访问指定域名
- ✅ VIP组用户可访问更多域名
- ✅ SVIP组用户可访问所有域名
- ✅ 无权限时正确拒绝操作

### 2. 积分测试
- ✅ 默认组添加记录消耗1积分
- ✅ VIP组按配置消耗积分
- ✅ SVIP组免费添加记录
- ✅ 积分不足时正确拒绝

### 3. 限制测试
- ✅ 默认组达到100条记录限制
- ✅ VIP组达到500条记录限制
- ✅ SVIP组无限制

### 4. 管理测试
- ✅ 管理员可修改用户组
- ✅ 管理员可配置组权限
- ✅ 管理员可添加/删除用户组
- ✅ 操作日志正确记录

---

## 📈 实施时间表

### 第1天：数据库和核心逻辑（基础架构）
- ✅ 修改 `config/database.php`，添加表初始化方法
- ✅ 创建 `includes/user_groups.php` 类
- ✅ 修改 `includes/functions.php`，添加权限检查函数
- ✅ 测试数据库表创建和数据插入

### 第2天：管理后台开发（管理功能）
- ✅ 创建 `admin/user_groups.php` 页面（含自动检测）
- ✅ 实现用户组CRUD功能
- ✅ 实现域名权限配置功能
- ✅ 修改 `admin/users.php`，添加组管理
- ✅ 修改 `admin/includes/sidebar.php`，添加菜单

### 第3天：用户注册和记录逻辑（核心业务）
- ✅ 修改 `user/login.php` 注册逻辑
- ✅ 修改 `user/dashboard.php` 记录添加逻辑
- ✅ 添加权限检查和积分计算
- ✅ 添加域名过滤和限制检查

### 第4天：前台显示和优化（用户体验）
- ✅ 优化 `user/dashboard.php` 用户组信息显示
- ✅ 修改 `user/profile.php` 显示组信息
- ✅ 添加友好的权限提示信息
- ✅ 前端界面美化

### 第5天：测试和文档（质量保证）
- ✅ 单元测试（权限检查、积分计算）
- ✅ 集成测试（完整流程）
- ✅ 性能测试（查询优化）
- ✅ 更新用户文档和管理员手册

---

## 🔄 数据库初始化流程图

```
系统启动
    ↓
新安装？
    ├─ 是 → config/database.php::initTables()
    │         ↓
    │       initUserGroupTables()
    │         ↓
    │       创建表 + 插入默认数据
    │         ↓
    │       完成
    │
    └─ 否 → 已安装系统
              ↓
            访问 admin/user_groups.php
              ↓
            initializeUserGroupTables($db)
              ↓
            检测表是否存在？
              ├─ 存在 → 检测字段是否完整？
              │           ├─ 完整 → 跳过
              │           └─ 缺失 → 添加字段 + 索引
              │
              └─ 不存在 → 创建表 + 插入默认数据
                            ↓
                          创建索引
                            ↓
                          完成
```

---

## 💡 总结

用户组功能将为六趣DNS管理系统带来：
1. 🎯 **分层管理** - 不同用户享受不同权限
2. 💰 **差异化定价** - 灵活的积分消耗策略
3. 🔒 **精细权限控制** - 域名级别的访问控制
4. 📊 **可扩展性** - 易于添加新的用户组类型
5. 👥 **用户激励** - 鼓励用户升级到高级组

这将极大地提升系统的商业价值和用户体验！🚀

---

## 🔥 关键设计决策

### 1. 数据库初始化的双重保障
- **新安装**: 在 `config/database.php` 中自动创建
- **已安装**: 在 `admin/user_groups.php` 中检测并创建

**原因**: 确保无论是新安装还是老系统升级，都能正常使用用户组功能。

### 2. 默认用户组 (ID=1) 不可删除
所有新用户默认分配到 ID=1 的默认组，这个组不允许删除，防止外键约束错误。

### 3. SVIP组的特殊权限
- `can_access_all_domains = 1`: 可访问所有域名
- `points_per_record = 0`: 免费添加记录
- `max_records = -1`: 无限制记录数

### 4. 权限检查的性能优化
- 用户组信息缓存到 Session
- 使用索引优化查询
- 批量查询减少数据库访问

---

## ⚠️ 注意事项

### 开发注意
1. 所有权限检查必须在服务端进行，前端隐藏仅为用户体验
2. 修改用户组时必须记录操作日志 (group_changed_at, group_changed_by)
3. 删除用户组前必须检查是否有用户使用该组
4. 域名权限变更时需要清理相关缓存

### 安全注意
1. 防止用户通过修改表单绕过前端限制
2. 所有数据库操作使用预处理语句
3. 记录所有用户组变更操作到 action_logs
4. API接口需要验证用户组权限

### 性能注意
1. 避免在循环中查询用户组信息
2. 合理使用索引
3. 考虑添加缓存机制（Redis/Memcached）
4. 定期清理过期的权限关联

---

## 📞 技术支持

如实施过程中遇到问题，请参考：
1. 本设计文档
2. 代码注释
3. 数据库表结构说明
4. 测试用例

祝开发顺利！🎉

